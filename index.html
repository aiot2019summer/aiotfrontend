<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,height=device-height">
  <title>test</title>
  <style>
    ::-webkit-scrollbar {
      display: none;
    }

    html,
    body {
      overflow: hidden;
      height: 100%;
      margin: 0;
    }
  </style>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css" >
</head>

<body>
<script src="js/g2.min.js"></script>
<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="node_modules/mqtt/dist/mqtt.min.js"></script>
<script src="mqtt_connection.js"></script>

<!--左上放视频-->
<div class="top float-left" id="video">
    <!--<img src="/api/video_feed">-->
</div>

<!--右上放热力图-->
<div class="top float-right" id="heatmap"></div>
<script>
  function change(data) {
    var newList = [];
    var map = {};
    for (var i = 0; i < data.length; i++) {
      var m = 0.001; //图像横轴以m为间隔,纵轴以m为间隔分割成一个个区间
      var new_data = data;
      new_data[i].g = parseInt(data[i].x / m); //获取x所属区间的行索引
      new_data[i].l = parseInt(data[i].y / m);//获取y所属区间的列索引
    }
    for (var i = 0; i < new_data.length; i++) {
      var obj = new_data[i];
      if ((!(map[obj.g])) && (!(map[obj.l]))) {
        newList.push({
          g:m* obj.g,
          l:m*obj.l,
          tmp: 1
        });
        map[obj.g, obj.l] = obj;
      }//将不重复元素放入obj中
      else {
        for (var j = 0; j < newList.length; j++) {
          if ((newList[j].g == m*obj.g) && (newList[j].l == m*obj.l)) {
            newList[j].tmp++;
            break;
          }
        }
      }
    }
    return newList;
  }
//因为如没有初始数据就画图，会出现背景位置、大小不对的问题（未解决），现先给一个0值绘图使其正常
  var data=[{"g":0,"l":0,"tmp":0}];
  //为了将数据与图片上的位置完全吻合，需要将横轴和纵轴的范围设定为数据对应范围，并将范围优化处理关闭
  var defs = {
    'g': {
      type: 'linear',
      min: 0,
      max: 1440,
      nice: false//优化处理关闭
    },
    'l': {
      type: 'linear',
      min: 0,
      max: 1080,
      nice: false//优化处理关闭
    }
  };
      
  var chart_1 = new G2.Chart({
      container: 'heatmap',
      forceFit: false,
      width:950,
      height: 500,
      padding: [30, 30, 60, 30]
    });
  chart_1.source(data,defs);
  chart_1.tooltip({
    showTitle: false
  });
  chart_1.axis(false);
  chart_1.legend({
    offset: 10
  });
  chart_1.heatmap().position('g*l').color('tmp',
  '#0000FF-#0033FF-#0066FF-#0099FF-#00CCFF-#00FFFF-#00FFCC-#00FF99-#00FF66-#00FF33-#00FF00-#33FF00-#33FF00-#66FF00-#99FF00-#CCFF00-#33FF00-#FFFF00-#FFCC00-#FF9900-#FF6600-#FF3300-#FF0000')
  .size(60);

  chart_1.guide().image({
    start: ['min', 'max'],
    end: ['max', 'min'],
  src: 'hall.jpg'
  });
  chart_1.render();
  //收到数据后刷新
  client.on('message', (topic, message) => {
    data1=eval("("+message.toString()+")");
    data2 = change(data1);
    console.log(data2);
    chart_1.changeData(data2);
  })
</script>

<!--下面放图表-->
<div class="bottom-div margin:auto;" id="area_chart"></div>
<script>
var data = [];
  var chart_2= new G2.Chart({
    container: 'area_chart',
    forceFit: false,
    width: 1850,
    height: 450
  });
  chart_2.source(data);
  chart_2.scale('people', {
    tickInterval: 10,
    min: 0
  });
  chart_2.scale('time', {
    tickInterval: 1,
    min: 0,
    max: 60
  });

  chart_2.tooltip({
    crosshairs: {
      type: 'line'
    }
  });
  chart_2.area().position('time*people');
  chart_2.line().position('time*people').size(2);
  // chart_2.line().position('time*people');
  chart_2.point().position('time*people').size(2).shape('circle').style({
    stroke: '#3300FF',
    lineWidth: 2
  });
  chart_2.axis('xField', {
    line: {
      lineWidth: 14, // 设置线的宽度
      stroke: 'black', // 设置线的颜色
      lineDash: [ 3, 3 ] // 设置虚线样式
    }
  });

  chart_2.render();


  //接收到新数据后，push进data
  client.on('message', (topic, message) => {
    data_temp=eval("("+message.toString()+")");
    var people = data_temp.length - 1;
    data_temp = data_temp.slice(data_temp.length - 1, data_temp.length)

    data_temp[0].people = people;

    data.push(data_temp[0]);
    console.log(data);

    //重新绘图
    chart_2.changeData(data);
  })
  
</script>

</body>

</html>